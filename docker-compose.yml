
services:
  # Production build
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      args:
        - VITE_NEWS_API_KEY=${VITE_NEWS_API_KEY}
        - VITE_GUARDIAN_KEY=${VITE_GUARDIAN_KEY}
        - VITE_NY_TIMES_KEY=${VITE_NY_TIMES_KEY}
    ports:
      - "3000:80"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Development server
  dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - VITE_NEWS_API_KEY=${VITE_NEWS_API_KEY}
      - VITE_GUARDIAN_KEY=${VITE_GUARDIAN_KEY}
      - VITE_NY_TIMES_KEY=${VITE_NY_TIMES_KEY}
    command: pnpm dev --host
    profiles:
      - dev

  # Unit tests
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    volumes:
      - .:/app
      - /app/node_modules
    command: pnpm test
    profiles:
      - test

  # Dev server for E2E tests
  dev-server:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - VITE_NEWS_API_KEY=${VITE_NEWS_API_KEY}
      - VITE_GUARDIAN_KEY=${VITE_GUARDIAN_KEY}
      - VITE_NY_TIMES_KEY=${VITE_NY_TIMES_KEY}
    command: sh -c "pnpm exec vite --port 3000 --host"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 2s
      timeout: 5s
      retries: 30
      start_period: 10s
    profiles:
      - test

  # E2E tests - requires dev server to be running
  test-e2e:
    build:
      context: .
      dockerfile: Dockerfile.test
    volumes:
      - .:/app
      - /app/node_modules
      - /app/test-results
      - /app/playwright-report
    environment:
      - CI=true
      - DOCKER=true
      - VITE_NEWS_API_KEY=${VITE_NEWS_API_KEY}
      - VITE_GUARDIAN_KEY=${VITE_GUARDIAN_KEY}
      - VITE_NY_TIMES_KEY=${VITE_NY_TIMES_KEY}
    network_mode: service:dev-server
    depends_on:
      dev-server:
        condition: service_healthy
    command: pnpm test:e2e
    profiles:
      - test

